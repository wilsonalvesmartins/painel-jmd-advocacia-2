<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Processos v7 - JMD Advocacia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 24px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .hidden { display: none; }
        .nav-link { cursor: pointer; padding: 8px 16px; border-radius: 6px; font-weight: 600; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #132433; color: #f1f5f9; }
        .nav-link:not(.active) { color: #132433; }
        .nav-link:not(.active):hover { background-color: #ffffff; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.8rem; position: relative; min-height: 100px; }
        .day-number { font-size: 0.9rem; margin-bottom: 4px; }
        .calendar-event { font-size: 0.7rem; padding: 2px 4px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .event-audiencia { background-color: #3b82f6; color: white; }
        .event-prazo { background-color: #ef4444; color: white; }
        .movimentacao-item.concluida { text-decoration: line-through; opacity: 0.6; }
        #tribunalFilterModal .modal-content { max-height: 80vh; display: flex; flex-direction: column; }
        #tribunalList { overflow-y: auto; }
    </style>
     <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'primary': '#132433',
                'secondary': '#f1f5f9',
                'accent': '#bfbfbf'
              }
            }
          }
        }
      </script>
</head>
<body class="antialiased">

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-secondary">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <img id="logoLogin" src="https://placehold.co/300x80/132433/d9d9d9?text=JMD+Advocacia" alt="Logo" class="mx-auto mb-6 h-16 object-contain">
            <h2 class="text-2xl font-bold mb-6 text-center text-primary">Acesso ao Painel</h2>
            <form id="loginForm"><div class="mb-4"><label for="username" class="block text-sm font-medium text-gray-700 mb-1">Utilizador</label><input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required></div><div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-700 mb-1">Palavra-passe</label><input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required></div><p id="loginError" class="text-red-500 text-sm text-center mb-4 hidden">Utilizador ou palavra-passe inválidos.</p><button type="submit" class="w-full bg-primary text-white font-semibold py-2 px-5 rounded-md hover:opacity-90 shadow transition-opacity">Entrar</button></form>
        </div>
    </div>

    <!-- Painel Principal (Inicialmente Oculto) -->
    <div id="app" class="p-4 sm:p-6 lg:p-8 hidden">
        <header class="mb-8"><div class="max-w-7xl mx-auto"><div class="flex items-center justify-between"><div class="flex items-center gap-4"><img id="logoApp" src="https://placehold.co/200x60/132433/d9d9d9?text=JMD+Advocacia" alt="Logo" class="h-12 object-contain"><h2 class="text-xl font-semibold text-primary/80 hidden sm:block">Painel de Acompanhamento Processual</h2></div><button id="logoutBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 shadow flex items-center gap-2"><i class="fa fa-sign-out-alt"></i><span>Sair</span></button></div><nav id="main-nav" class="mt-6 flex items-center gap-2 bg-white p-1 rounded-lg shadow-sm"><a id="nav-processos" class="nav-link active">Painel de Processos</a><a id="nav-gestao" class="nav-link">Gestão</a><a id="nav-calendario" class="nav-link">Calendário</a><a id="nav-config" class="nav-link">Configurações</a></nav></div></header>

        <main class="max-w-7xl mx-auto">
            <!-- PÁGINA: PAINEL DE PROCESSOS -->
            <div id="page-processos">
                 <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap gap-4 flex-grow">
                        <div class="relative flex-grow min-w-[200px]"><i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input id="searchInput" type="text" placeholder="Procurar por nº ou cliente..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md"></div>
                        <div class="relative flex-grow min-w-[150px]"><i class="fa fa-landmark absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input id="varaSearchInput" type="text" placeholder="Vara..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md"></div>
                    </div>
                    <button id="addProcessBtn" class="bg-primary text-white font-semibold py-2 px-5 rounded-md hover:opacity-90 shadow flex items-center gap-2 transition-opacity"><i class="fa fa-plus"></i><span>Novo Processo</span></button>
                </div>
                <div id="processList" class="space-y-4"></div><div id="loading-state" class="text-center py-10"><p class="text-gray-600 text-lg">A carregar processos...</p></div><div id="error-state" class="hidden text-center py-10 bg-red-50 border border-red-200 rounded-lg"><p id="errorMessage" class="text-red-600 font-semibold text-lg">Falha ao carregar processos.</p></div><div id="no-results" class="hidden text-center py-10"><p class="text-gray-600 text-lg">Nenhum processo encontrado.</p></div>
            </div>

            <!-- PÁGINA: GESTÃO -->
            <div id="page-gestao" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-primary mb-4">Pendentes de Manifestação</h3><div id="gestao-pendentes" class="space-y-3"></div></div>
                    <div class="bg-white p-5 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-primary mb-4">Em Fase de Execução</h3><div id="gestao-execucao" class="space-y-3"></div></div>
                </div>
                <div class="bg-white p-5 rounded-lg shadow-sm mt-6"><h3 class="text-xl font-bold text-primary mb-4">Movimentações da Semana</h3><div id="gestao-semana" class="space-y-3"></div></div>
            </div>

            <!-- PÁGINA: CALENDÁRIO -->
            <div id="page-calendario" class="hidden">
                 <div class="bg-white p-5 rounded-lg shadow-sm mb-6">
                    <h3 class="text-xl font-bold text-primary mb-4">Próximas Audiências</h3>
                    <div id="proximas-audiencias-list" class="space-y-2 mb-6"></div>
                    <hr class="mb-6">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-primary">Calendário de Eventos</h3><div class="flex items-center gap-4 text-sm"><span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-500"></div> Audiências</span><span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div> Prazos</span></div></div>
                    <div class="flex items-center justify-between mb-4"><button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button><h4 id="calendar-month-year" class="text-lg font-semibold text-primary"></h4><button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button></div>
                    <div id="calendar-container"></div>
                 </div>
            </div>
            
            <!-- PÁGINA: CONFIGURAÇÕES -->
            <div id="page-config" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white p-5 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-primary mb-4">Personalizar Aparência</h3><div><label for="logoUrlInput" class="block text-sm font-medium text-gray-700 mb-1">URL do Logo</label><div class="flex gap-2"><input type="url" id="logoUrlInput" placeholder="https://exemplo.com/logo.png" class="w-full px-3 py-2 border border-gray-300 rounded-md"><button id="saveLogoBtn" class="bg-primary text-white font-semibold py-2 px-4 rounded-md hover:opacity-90">Salvar</button></div></div></div><div class="bg-white p-5 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-primary mb-4">Personalizar Menu</h3><form id="customMenuForm" class="flex gap-2 mb-4"><input type="text" id="menuText" placeholder="Texto do botão" class="w-1/2 px-3 py-2 border border-gray-300 rounded-md" required><input type="url" id="menuUrl" placeholder="URL de destino" class="w-1/2 px-3 py-2 border border-gray-300 rounded-md" required><button type="submit" class="bg-primary text-white font-semibold py-2 px-4 rounded-md hover:opacity-90">Adicionar</button></form><h4 class="text-md font-medium text-gray-700 mb-2">Itens existentes:</h4><div id="customMenuItemsList" class="space-y-2"></div></div></div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <!-- Modal para Adicionar/Editar Processo -->
    <div id="processModal" class="modal"><div class="modal-content animate-fade-in">
        <form id="processForm">
            <h3 id="processModalTitle" class="text-2xl font-bold mb-6 text-primary">Novo Processo</h3><input type="hidden" id="processId">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="sm:col-span-2"><label for="nomeCliente" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label><input type="text" id="nomeCliente" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="numeroProcesso" class="block text-sm font-medium text-gray-700 mb-1">Número do Processo</label><input type="text" id="numeroProcesso" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="areaDireito" class="block text-sm font-medium text-gray-700 mb-1">Área do Direito</label><select id="areaDireito" class="w-full px-3 py-2 border border-gray-300 rounded-md"><option value="">Selecione...</option><option value="Trabalhista">Trabalhista</option><option value="Cível">Cível</option><option value="Família">Família</option></select></div>
                <div><label for="tribunal" class="block text-sm font-medium text-gray-700 mb-1">Tribunal</label><input type="text" id="tribunal" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="vara" class="block text-sm font-medium text-gray-700 mb-1">Vara</label><input type="text" id="vara" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div class="sm:col-span-2"><label for="proximaAudiencia" class="block text-sm font-medium text-gray-700 mb-1">Data e Hora da Audiência</label><input type="datetime-local" id="proximaAudiencia" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div class="sm:col-span-2"><label for="modoAudiencia" class="block text-sm font-medium text-gray-700 mb-1">Modo da Audiência</label><select id="modoAudiencia" class="w-full px-3 py-2 border border-gray-300 rounded-md"><option value="">Nenhum</option><option value="Online">Online</option><option value="Presencial">Presencial</option></select></div>
                <div id="linkAudienciaContainer" class="hidden sm:col-span-2"><label for="linkAudiencia" class="block text-sm font-medium text-gray-700 mb-1">Link da Audiência</label><input type="url" id="linkAudiencia" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
            </div>
            <div id="editExtraFields" class="hidden mt-4"><hr class="my-4"><h4 class="text-md font-medium text-gray-700 mb-2">Links de Documentos</h4><div id="linksList" class="space-y-2 mb-2"></div><div class="flex gap-2"><input type="url" id="newLinkUrl" placeholder="URL do documento" class="w-full px-3 py-2 border border-gray-300 rounded-md"><input type="text" id="newLinkDesc" placeholder="Descrição (Ex: Petição Inicial)" class="w-full px-3 py-2 border border-gray-300 rounded-md"><button type="button" id="addLinkBtn" class="bg-blue-500 text-white px-3 rounded-md hover:bg-blue-600"><i class="fa fa-plus"></i></button></div></div>
            <div class="mt-8 flex justify-end gap-3"><button type="button" data-modal-close class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button><button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-semibold">Salvar</button></div>
        </form>
    </div></div>
    
    <!-- Modal para Adicionar Movimentação -->
    <div id="movimentacaoModal" class="modal"><div class="modal-content animate-fade-in"><form id="movimentacaoForm"><h3 class="text-2xl font-bold mb-6 text-primary">Adicionar Movimentação</h3><input type="hidden" id="movimentacaoProcessId"><div><label for="movimentacaoDescricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea id="movimentacaoDescricao" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div><div class="mt-4"><label class="flex items-center"><input type="checkbox" id="definirPrazo" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"> <span class="ml-2 text-sm text-gray-700">Definir prazo fatal</span></label></div><div id="prazoFatalContainer" class="mt-4 hidden"><label for="prazoFatal" class="block text-sm font-medium text-gray-700 mb-1">Data do Prazo</label><input type="date" id="prazoFatal" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="mt-8 flex justify-end gap-3"><button type="button" data-modal-close class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button><button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-semibold">Adicionar</button></div></form></div></div>
    
    <!-- Modal para Editar Movimentação -->
    <div id="movimentacaoEditModal" class="modal"><div class="modal-content animate-fade-in"><form id="movimentacaoEditForm"><h3 class="text-2xl font-bold mb-6 text-primary">Editar Movimentação</h3><input type="hidden" id="movimentacaoEditId"><input type="hidden" id="movimentacaoEditProcessId"><div><label for="movimentacaoEditDescricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea id="movimentacaoEditDescricao" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div><div class="mt-4"><label class="flex items-center"><input type="checkbox" id="movimentacaoEditConcluido" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"><span class="ml-2 text-sm text-gray-700">Marcar como concluída</span></label></div><div class="mt-8 flex justify-end gap-3"><button type="button" data-modal-close class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button><button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-semibold">Salvar Alterações</button></div></form></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTOS DA UI ---
    const pages = { processos: document.getElementById('page-processos'), gestao: document.getElementById('page-gestao'), calendario: document.getElementById('page-calendario'), config: document.getElementById('page-config') };
    const navLinks = { processos: document.getElementById('nav-processos'), gestao: document.getElementById('nav-gestao'), calendario: document.getElementById('nav-calendario'), config: document.getElementById('nav-config') };
    const processModal = document.getElementById('processModal');
    const movimentacaoModal = document.getElementById('movimentacaoModal');
    const movimentacaoEditModal = document.getElementById('movimentacaoEditModal');
    
    let allProcesses = [];
    let currentProcessId = null; // Para gerir o ID do processo no modal de edição
    let calendarDate = new Date();
    const statusOptions = ["Distribuído", "Pendente de manifestação", "Aguardando Audiência", "Sentença", "Recurso", "Liquidação", "Em fase de execução", "Encerrado"];
    const statusColors = {
        "Distribuído": "bg-blue-100 text-blue-800",
        "Pendente de manifestação": "bg-yellow-100 text-yellow-800",
        "Aguardando Audiência": "bg-purple-100 text-purple-800",
        "Sentença": "bg-green-100 text-green-800",
        "Recurso": "bg-orange-100 text-orange-800",
        "Liquidação": "bg-teal-100 text-teal-800",
        "Em fase de execução": "bg-pink-100 text-pink-800",
        "Encerrado": "bg-gray-200 text-gray-800",
        "default": "bg-gray-100 text-gray-800"
    };
    const tribunais = ['STF', 'STJ', 'TST', 'TJs', 'TRFs', 'TRTs', 'TSE', 'TREs', 'STM', 'TJMs', 'TCU'];

    // --- LÓGICA DE API ---
    const apiRequest = async (url, options = {}) => {
        try {
            const response = await fetch(`/api${url}`, options);
            if (!response.ok) throw new Error( (await response.json()).message || 'Erro de servidor');
            if (response.status === 204) return null;
            return response.json();
        } catch (error) {
            console.error('Erro na API:', error);
            alert(`Erro na comunicação com o servidor: ${error.message}`);
            throw error;
        }
    };
    
    // --- LÓGICA DE AUTENTICAÇÃO E INICIALIZAÇÃO ---
    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app');
    const showLoginScreen = () => { loginScreen.classList.remove('hidden'); appScreen.classList.add('hidden'); sessionStorage.removeItem('loggedIn'); };
    const showAppScreen = () => { loginScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); sessionStorage.setItem('loggedIn', 'true'); navigateTo('processos'); };
    
    const initializeAppSettings = () => {
        const savedLogo = localStorage.getItem('customLogoUrl');
        if (savedLogo) {
            document.getElementById('logoUrlInput').value = savedLogo;
            document.getElementById('logoLogin').src = savedLogo;
            document.getElementById('logoApp').src = savedLogo;
        }
        renderCustomMenu();
    };

    document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); if (document.getElementById('username').value === 'escritorio' && document.getElementById('password').value === '36672456') showAppScreen(); else document.getElementById('loginError').classList.remove('hidden'); });
    document.getElementById('logoutBtn').addEventListener('click', showLoginScreen);
    
    // --- LÓGICA DE NAVEGAÇÃO ---
    const navigateTo = (pageKey) => {
        Object.values(pages).forEach(p => p.classList.add('hidden'));
        Object.values(navLinks).forEach(l => l.classList.remove('active'));
        pages[pageKey].classList.remove('hidden');
        navLinks[pageKey].classList.add('active');

        if (pageKey === 'processos') fetchProcesses();
        if (pageKey === 'gestao') fetchGestaoData();
        if (pageKey === 'calendario') fetchCalendarData();
        if (pageKey === 'config') renderCustomMenuItemsList();
    };
    Object.keys(navLinks).forEach(key => navLinks[key].addEventListener('click', () => navigateTo(key)));

    // --- LÓGICA DE PROCESSOS ---
    const fetchProcesses = async () => {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('processList').innerHTML = '';
        try {
            const params = new URLSearchParams({
                search: document.getElementById('searchInput').value,
                vara: document.getElementById('varaSearchInput').value
            });
            allProcesses = await apiRequest(`/processes?${params.toString()}`);
            renderProcesses();
        } catch (error) {
            document.getElementById('error-state').classList.remove('hidden');
        }
    };

    const renderProcesses = () => {
        document.getElementById('loading-state').classList.add('hidden');
        const listEl = document.getElementById('processList');
        listEl.innerHTML = '';
        if (allProcesses.length === 0) { document.getElementById('no-results').classList.remove('hidden'); return; }
        document.getElementById('no-results').classList.add('hidden');

        allProcesses.forEach(p => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md p-5 border-l-4 border-primary transition hover:shadow-lg';
            const statusColor = statusColors[p.status] || statusColors.default;
            card.innerHTML = `
                <div class="flex flex-wrap justify-between items-start gap-4">
                    <div class="flex-grow cursor-pointer" data-action="edit-process" data-id="${p.id}">
                        <div class="flex items-center flex-wrap gap-2 mb-2">
                           <span class="text-xs font-semibold py-1 px-2 rounded-full bg-gray-200 text-gray-800">${p.area_direito || 'N/A'}</span>
                           <span class="text-xs font-semibold py-1 px-2 rounded-full ${statusColor}">${p.status || 'Não definido'}</span>
                           ${p.modo_audiencia === 'Online' && p.link_audiencia ? `<a href="${p.link_audiencia}" target="_blank" onclick="event.stopPropagation()" class="text-xs font-semibold py-1 px-2 rounded-full bg-green-100 text-green-800 hover:bg-green-200"><i class="fa fa-video mr-1"></i>Link Audiência</a>` : ''}
                        </div>
                        <h3 class="text-xl font-bold text-primary">${p.cliente}</h3>
                        <p class="text-md text-gray-700">${p.numero}</p>
                        <p class="text-sm text-gray-500 mt-1">${p.tribunal || ''} - ${p.vara || ''}</p>
                    </div>
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <select data-id="${p.id}" class="status-select text-sm border-gray-300 rounded-md">${statusOptions.map(opt => `<option value="${opt}" ${p.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>
                        <button data-id="${p.id}" data-action="add-movimentacao" class="bg-primary text-white h-9 w-9 grid place-content-center rounded-full hover:opacity-90" title="Adicionar Movimentação"><i class="fa fa-plus"></i></button>
                        <button data-id="${p.id}" data-action="delete-process" class="bg-red-600 text-white h-9 w-9 grid place-content-center rounded-full hover:bg-red-700" title="Excluir Processo"><i class="fa fa-trash"></i></button>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200"><h4 class="text-sm font-medium text-gray-500 mb-2">Últimas Movimentações</h4><div class="space-y-2 text-sm">
                    ${[...(p.movimentacoes || [])].reverse().slice(0, 3).map(m => `<div class="movimentacao-item ${m.concluido ? 'concluida' : ''} p-2 bg-gray-50 rounded-md cursor-pointer hover:bg-gray-100" data-action="edit-movimentacao" data-process-id="${p.id}" data-mov-id="${m.id}"><p class="text-gray-800 pointer-events-none">${m.descricao}</p><div class="flex justify-between items-center mt-1 pointer-events-none"><span class="text-xs text-gray-500">${new Date(m.timestamp).toLocaleString('pt-BR')}</span>${m.prazo_fatal ? `<span class="text-xs font-semibold text-red-600">Prazo: ${new Date(m.prazo_fatal).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</span>` : ''}</div></div>`).join('') || '<p class="text-xs text-gray-500">Nenhuma movimentação registada.</p>'}
                </div></div>`;
            listEl.appendChild(card);
        });
    };
    
    [document.getElementById('searchInput'), document.getElementById('varaSearchInput')].forEach(el => el.addEventListener('input', fetchProcesses));

    // --- LÓGICA DOS MODAIS (Abrir/Fechar) ---
    const openModal = (modalElement) => modalElement.style.display = 'flex';
    const closeModal = (modalElement) => modalElement.style.display = 'none';
    document.querySelectorAll('[data-modal-close]').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));
    window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target); });

    // --- LÓGICA DE AÇÕES ---
    document.getElementById('processList').addEventListener('click', async e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const { action, id } = target.dataset;
        if (action === 'delete-process') {
            if (confirm(`Tem a certeza que quer excluir o processo? Esta ação não pode ser desfeita.`)) {
                await apiRequest(`/processes/${id}`, { method: 'DELETE' });
                fetchProcesses();
            }
            return;
        }
        if (action === 'add-movimentacao') { openMovimentacaoModal(id); return; }
        
        const process = allProcesses.find(p => p.id == (id || target.dataset.processId));
        if (!process) return;

        switch (action) {
            case 'edit-process': openProcessModal(process); break;
            case 'edit-movimentacao': 
                const mov = process.movimentacoes.find(m => m.id == target.dataset.movId);
                if(mov) openMovimentacaoEditModal(target.dataset.processId, mov);
                break;
        }
    });

    document.getElementById('addProcessBtn').addEventListener('click', () => openProcessModal());

    const openProcessModal = (process = null) => {
        const processForm = document.getElementById('processForm');
        processForm.reset();
        currentProcessId = process ? process.id : null;
        document.getElementById('processId').value = currentProcessId;
        document.getElementById('processModalTitle').textContent = process ? 'Editar Processo' : 'Novo Processo';
        
        if (process) {
            document.getElementById('numeroProcesso').value = process.numero;
            document.getElementById('nomeCliente').value = process.cliente;
            document.getElementById('areaDireito').value = process.area_direito || '';
            document.getElementById('tribunal').value = process.tribunal || '';
            document.getElementById('vara').value = process.vara || '';
            if (process.proxima_audiencia) {
                const date = new Date(process.proxima_audiencia);
                const localISOString = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                document.getElementById('proximaAudiencia').value = localISOString;
            }
            document.getElementById('modoAudiencia').value = process.modo_audiencia || '';
            document.getElementById('linkAudiencia').value = process.link_audiencia || '';
            document.getElementById('editExtraFields').classList.remove('hidden');
            renderLinks(process.links);
        } else {
            document.getElementById('editExtraFields').classList.add('hidden');
        }
        document.getElementById('modoAudiencia').dispatchEvent(new Event('change'));
        openModal(processModal);
    };

    document.getElementById('processForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('processId').value;
        const data = {
            numero: document.getElementById('numeroProcesso').value,
            cliente: document.getElementById('nomeCliente').value,
            area_direito: document.getElementById('areaDireito').value,
            tribunal: document.getElementById('tribunal').value,
            vara: document.getElementById('vara').value,
            proxima_audiencia: document.getElementById('proximaAudiencia').value,
            modo_audiencia: document.getElementById('modoAudiencia').value,
            link_audiencia: document.getElementById('linkAudiencia').value
        };
        await apiRequest(id ? `/processes/${id}` : '/processes', { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        closeModal(processModal);
        fetchProcesses();
    });

    document.getElementById('modoAudiencia').addEventListener('change', e => { document.getElementById('linkAudienciaContainer').classList.toggle('hidden', e.target.value !== 'Online'); });
    
    // --- LÓGICA DE MOVIMENTAÇÕES, STATUS, LINKS ---
    const openMovimentacaoModal = (processId) => { document.getElementById('movimentacaoForm').reset(); document.getElementById('movimentacaoProcessId').value = processId; document.getElementById('prazoFatalContainer').classList.add('hidden'); openModal(movimentacaoModal); };
    const openMovimentacaoEditModal = (processId, mov) => { document.getElementById('movimentacaoEditForm').reset(); document.getElementById('movimentacaoEditProcessId').value = processId; document.getElementById('movimentacaoEditId').value = mov.id; document.getElementById('movimentacaoEditDescricao').value = mov.descricao; document.getElementById('movimentacaoEditConcluido').checked = mov.concluido; openModal(movimentacaoEditModal); };
    document.getElementById('definirPrazo').addEventListener('change', e => { document.getElementById('prazoFatalContainer').classList.toggle('hidden', !e.target.checked);});
    document.getElementById('movimentacaoForm').addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('movimentacaoProcessId').value; const data = { descricao: document.getElementById('movimentacaoDescricao').value, prazo_fatal: document.getElementById('definirPrazo').checked ? document.getElementById('prazoFatal').value : null }; await apiRequest(`/processes/${id}/movimentacoes`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); closeModal(movimentacaoModal); fetchProcesses(); if(pages.gestao.offsetParent) fetchGestaoData(); if(pages.calendario.offsetParent) fetchCalendarData(); });
    document.getElementById('movimentacaoEditForm').addEventListener('submit', async (e) => { e.preventDefault(); const processId = document.getElementById('movimentacaoEditProcessId').value; const movId = document.getElementById('movimentacaoEditId').value; const data = { descricao: document.getElementById('movimentacaoEditDescricao').value, concluido: document.getElementById('movimentacaoEditConcluido').checked }; await apiRequest(`/processes/${processId}/movimentacoes/${movId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); closeModal(movimentacaoEditModal); fetchProcesses(); });
    document.getElementById('processList').addEventListener('change', async e => { if (e.target.classList.contains('status-select')) { const id = e.target.dataset.id; const newStatus = e.target.value; await apiRequest(`/processes/${id}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) }); fetchProcesses(); }});
    
    const renderLinks = (links = []) => { const list = document.getElementById('linksList'); list.innerHTML = links.map(link => `<div class="flex items-center justify-between bg-gray-100 p-2 rounded"><a href="${link.url}" target="_blank" class="text-sm text-blue-600 hover:underline truncate" title="${link.url}"><i class="fas fa-link mr-2"></i>${link.descricao}</a><button type="button" data-link-id="${link.id}" class="delete-link-btn text-red-500 hover:text-red-700 text-xs p-1"><i class="fas fa-trash"></i></button></div>`).join('') || '<p class="text-xs text-gray-500">Nenhum link adicionado.</p>'; };
    document.getElementById('addLinkBtn').addEventListener('click', async () => { const urlInput = document.getElementById('newLinkUrl'); const descInput = document.getElementById('newLinkDesc'); if (!urlInput.value || !descInput.value) { alert('URL e descrição são obrigatórios.'); return; } const updatedProcess = await apiRequest(`/processes/${currentProcessId}/links`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: urlInput.value, descricao: descInput.value }) }); renderLinks(updatedProcess.links); const index = allProcesses.findIndex(p => p.id == currentProcessId); if(index !== -1) allProcesses[index] = updatedProcess; urlInput.value = ''; descInput.value = ''; });
    document.getElementById('linksList').addEventListener('click', async e => { const deleteBtn = e.target.closest('.delete-link-btn'); if (deleteBtn && confirm('Tem a certeza?')) { const updatedProcess = await apiRequest(`/processes/${currentProcessId}/links/${deleteBtn.dataset.linkId}`, { method: 'DELETE' }); renderLinks(updatedProcess.links); const index = allProcesses.findIndex(p => p.id == currentProcessId); if(index !== -1) allProcesses[index] = updatedProcess; }});

    // --- LÓGICA CALENDÁRIO ---
    const fetchCalendarData = async () => {
        try {
            const data = await apiRequest('/calendario');
            renderCalendar(data.eventos);
            renderProximasAudiencias(data.proximasAudiencias);
        } catch (error) { document.getElementById('calendar-container').innerHTML = '<p class="text-red-500">Erro ao carregar eventos.</p>'; }
    };
    const renderProximasAudiencias = (audiencias) => { const list = document.getElementById('proximas-audiencias-list'); list.innerHTML = audiencias.map(a => `<div class="p-2 bg-gray-100 rounded text-sm flex justify-between items-center"><span><span class="font-bold">${a.cliente}</span> - ${new Date(a.proxima_audiencia).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</span><button class="text-xs bg-primary text-white px-2 py-1 rounded hover:opacity-80" onclick="navigateTo('processos'); document.getElementById('searchInput').value='${a.numero}'; fetchProcesses();">Ver Processo</button></div>`).join('') || '<p class="text-sm text-gray-500">Nenhuma audiência marcada para os próximos dias.</p>'};
    const renderCalendar = (events = { audiencias: [], prazos: [] }) => {
        const calendarContainer = document.getElementById('calendar-container'); calendarContainer.innerHTML = ''; const month = calendarDate.getMonth(); const year = calendarDate.getFullYear(); document.getElementById('calendar-month-year').textContent = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }); const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const grid = document.createElement('div'); grid.className = 'calendar-grid'; ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(day => { const h = document.createElement('div'); h.className = 'text-center font-bold text-xs text-primary'; h.textContent = day; grid.appendChild(h); });
        for (let i = 0; i < firstDayOfMonth; i++) { grid.appendChild(document.createElement('div')); }
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div'); dayEl.className = 'calendar-day'; const dayDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const audienciasDoDia = events.audiencias.filter(a => a.date && a.date.startsWith(dayDateStr)); const prazosDoDia = events.prazos.filter(p => p.date && p.date.startsWith(dayDateStr));
            let eventsHtml = `<span class="day-number">${day}</span>`;
            audienciasDoDia.forEach(a => { eventsHtml += `<div class="calendar-event event-audiencia">${a.cliente}</div>`});
            prazosDoDia.forEach(p => { eventsHtml += `<div class="calendar-event event-prazo">${p.cliente}</div>`});
            dayEl.innerHTML = eventsHtml;
            grid.appendChild(dayEl);
        }
        calendarContainer.appendChild(grid);
    };
    document.getElementById('prevMonthBtn').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); fetchCalendarData(); });
    document.getElementById('nextMonthBtn').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); fetchCalendarData(); });
    
    // --- GESTÃO E CONFIG (CORRIGIDOS) ---
    const fetchGestaoData = async () => { const data = await apiRequest('/gestao'); document.getElementById('gestao-pendentes').innerHTML = data.pendentes.map(p => `<div class="p-2 bg-gray-100 rounded text-sm">${p.numero} - ${p.cliente}</div>`).join('') || '<p class="text-sm text-gray-500">Nenhum.</p>'; document.getElementById('gestao-execucao').innerHTML = data.execucao.map(p => `<div class="p-2 bg-gray-100 rounded text-sm">${p.numero} - ${p.cliente}</div>`).join('') || '<p class="text-sm text-gray-500">Nenhum.</p>'; document.getElementById('gestao-semana').innerHTML = data.semana.map(m => `<div class="p-2 bg-gray-100 rounded text-sm"><p class="font-semibold">${m.numero}</p><p>${m.descricao}</p><p class="text-xs text-gray-500">${new Date(m.timestamp).toLocaleString('pt-BR')}</p></div>`).join('') || '<p class="text-sm text-gray-500">Nenhuma.</p>'; };
    document.getElementById('saveLogoBtn').addEventListener('click', () => { const url = document.getElementById('logoUrlInput').value; localStorage.setItem('customLogoUrl', url); document.getElementById('logoLogin').src = url || 'https://placehold.co/300x80/132433/d9d9d9?text=JMD+Advocacia'; document.getElementById('logoApp').src = url || 'https://placehold.co/200x60/132433/d9d9d9?text=JMD+Advocacia';});
    const getCustomMenuItems = () => JSON.parse(localStorage.getItem('customMenuItems') || '[]');
    const saveCustomMenuItems = (items) => localStorage.setItem('customMenuItems', JSON.stringify(items));
    const renderCustomMenu = () => { document.querySelectorAll('.custom-nav-item').forEach(item => item.remove()); getCustomMenuItems().forEach(item => { const link = document.createElement('a'); link.href = item.url; link.textContent = item.text; link.target = "_blank"; link.className = 'nav-link custom-nav-item'; document.getElementById('main-nav').appendChild(link); }); };
    const renderCustomMenuItemsList = () => { const items = getCustomMenuItems(); document.getElementById('customMenuItemsList').innerHTML = items.map((item, index) => `<div class="flex items-center justify-between bg-gray-100 p-2 rounded"><span class="text-sm">${item.text} -> ${item.url}</span><button data-index="${index}" class="delete-menu-item-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button></div>`).join('') || '<p class="text-xs text-gray-500">Nenhum.</p>';};
    document.getElementById('customMenuForm').addEventListener('submit', (e) => { e.preventDefault(); const items = getCustomMenuItems(); items.push({ text: document.getElementById('menuText').value, url: document.getElementById('menuUrl').value }); saveCustomMenuItems(items); renderCustomMenu(); renderCustomMenuItemsList(); e.target.reset(); });
    document.getElementById('customMenuItemsList').addEventListener('click', e => { const btn = e.target.closest('.delete-menu-item-btn'); if (btn) { let items = getCustomMenuItems(); items.splice(btn.dataset.index, 1); saveCustomMenuItems(items); renderCustomMenu(); renderCustomMenuItemsList(); } });
    
    // --- INICIALIZAÇÃO ---
    if (sessionStorage.getItem('loggedIn') === 'true') { initializeAppSettings(); showAppScreen(); } else { showLoginScreen(); }
});
</script>
</body>
</html>

