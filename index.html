<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Processos v3 - JMD Advocacia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #d9d9d9; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 24px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .hidden { display: none; }
        .nav-link { cursor: pointer; padding: 8px 16px; border-radius: 6px; font-weight: 600; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #132433; color: #d9d9d9; }
        .nav-link:not(.active) { color: #132433; }
        .nav-link:not(.active):hover { background-color: #ffffff; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1/1; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.8rem; position: relative; }
        .day-number { font-size: 0.9rem; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 4px; }
        .event-audiencia { background-color: #3b82f6; }
        .event-prazo { background-color: #f59e0b; }
        .movimentacao-item.concluida { text-decoration: line-through; opacity: 0.6; }
    </style>
     <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'primary': '#132433',
                'secondary': '#d9d9d9',
                'accent': '#bfbfbf'
              }
            }
          }
        }
      </script>
</head>
<body class="antialiased">

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-secondary">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <img id="logoLogin" src="https://placehold.co/300x80/132433/d9d9d9?text=JMD+Advocacia" alt="Logo" class="mx-auto mb-6 h-16 object-contain">
            <h2 class="text-2xl font-bold mb-6 text-center text-primary">Acesso ao Painel</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Utilizador</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Palavra-passe</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm text-center mb-4 hidden">Utilizador ou palavra-passe inválidos.</p>
                <button type="submit" class="w-full bg-primary text-secondary font-semibold py-2 px-5 rounded-md hover:opacity-90 shadow transition-opacity">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Painel Principal (Inicialmente Oculto) -->
    <div id="app" class="p-4 sm:p-6 lg:p-8 hidden">
        <header class="mb-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <img id="logoApp" src="https://placehold.co/200x60/132433/d9d9d9?text=JMD+Advocacia" alt="Logo" class="h-12 object-contain">
                        <h2 class="text-xl font-semibold text-primary/80 hidden sm:block">Painel de Acompanhamento Processual</h2>
                    </div>
                    <button id="logoutBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 shadow flex items-center gap-2">
                        <i class="fa fa-sign-out-alt"></i><span>Sair</span>
                    </button>
                </div>
                <nav id="main-nav" class="mt-6 flex items-center gap-2 bg-white p-1 rounded-lg shadow-sm">
                    <a id="nav-processos" class="nav-link active">Painel de Processos</a>
                    <a id="nav-gestao" class="nav-link">Gestão</a>
                    <a id="nav-config" class="nav-link">Configurações</a>
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto">
            <!-- PÁGINA: PAINEL DE PROCESSOS -->
            <div id="page-processos">
                 <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap gap-4 flex-grow">
                        <div class="relative flex-grow min-w-[200px]"><i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input id="searchInput" type="text" placeholder="Procurar por nº ou cliente..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md"></div>
                        <div class="relative flex-grow min-w-[150px]"><i class="fa fa-gavel absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input id="tribunalInput" type="text" placeholder="Tribunal..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md"></div>
                        <div class="relative flex-grow min-w-[150px]"><i class="fa fa-landmark absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input id="varaInput" type="text" placeholder="Vara..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md"></div>
                    </div>
                    <button id="addProcessBtn" class="bg-primary text-secondary font-semibold py-2 px-5 rounded-md hover:opacity-90 shadow flex items-center gap-2 transition-opacity">
                        <i class="fa fa-plus"></i><span>Novo Processo</span>
                    </button>
                </div>
                <div id="processList" class="space-y-4"></div>
                <div id="loading-state" class="text-center py-10"><p class="text-gray-600 text-lg">A carregar processos...</p></div>
                <div id="error-state" class="hidden text-center py-10 bg-red-50 border border-red-200 rounded-lg"><p id="errorMessage" class="text-red-600 font-semibold text-lg">Falha ao carregar processos.</p></div>
                <div id="no-results" class="hidden text-center py-10"><p class="text-gray-600 text-lg">Nenhum processo encontrado.</p></div>
            </div>

            <!-- PÁGINA: GESTÃO -->
            <div id="page-gestao" class="hidden">
                 <div class="bg-white p-5 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">Calendário de Eventos</h3>
                        <div class="flex items-center gap-4 text-sm">
                            <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-500"></div> Audiências</span>
                            <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-500"></div> Prazos</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-4">
                        <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                        <h4 id="calendar-month-year" class="text-lg font-semibold text-primary"></h4>
                        <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendar-container"></div>
                 </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-primary mb-4">Pendentes de Manifestação</h3><div id="gestao-pendentes" class="space-y-3"></div></div>
                    <div class="bg-white p-5 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-primary mb-4">Em Fase de Execução</h3><div id="gestao-execucao" class="space-y-3"></div></div>
                </div>
                <div class="bg-white p-5 rounded-lg shadow-sm mt-6"><h3 class="text-xl font-bold text-primary mb-4">Movimentações da Semana</h3><div id="gestao-semana" class="space-y-3"></div></div>
            </div>

            <!-- PÁGINA: CONFIGURAÇÕES -->
            <div id="page-config" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-primary mb-4">Personalizar Aparência</h3>
                        <div>
                            <label for="logoUrlInput" class="block text-sm font-medium text-gray-700 mb-1">URL do Logo</label>
                            <div class="flex gap-2">
                                <input type="url" id="logoUrlInput" placeholder="https://exemplo.com/logo.png" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <button id="saveLogoBtn" class="bg-primary text-secondary font-semibold py-2 px-4 rounded-md hover:opacity-90">Salvar</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-primary mb-4">Personalizar Menu</h3>
                        <form id="customMenuForm" class="flex gap-2 mb-4">
                            <input type="text" id="menuText" placeholder="Texto do botão" class="w-1/2 px-3 py-2 border border-gray-300 rounded-md" required>
                            <input type="url" id="menuUrl" placeholder="URL de destino" class="w-1/2 px-3 py-2 border border-gray-300 rounded-md" required>
                            <button type="submit" class="bg-primary text-secondary font-semibold py-2 px-4 rounded-md hover:opacity-90">Adicionar</button>
                        </form>
                        <h4 class="text-md font-medium text-gray-700 mb-2">Itens existentes:</h4>
                        <div id="customMenuItemsList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <!-- Modal para Adicionar/Editar Processo -->
    <div id="processModal" class="modal"><div class="modal-content animate-fade-in">
        <form id="processForm">
            <h3 id="processModalTitle" class="text-2xl font-bold mb-6 text-primary">Novo Processo</h3>
            <input type="hidden" id="processId">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="numeroProcesso" class="block text-sm font-medium text-gray-700 mb-1">Número do Processo</label><input type="text" id="numeroProcesso" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="nomeCliente" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label><input type="text" id="nomeCliente" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="areaDireito" class="block text-sm font-medium text-gray-700 mb-1">Área do Direito</label><select id="areaDireito" class="w-full px-3 py-2 border border-gray-300 rounded-md"><option value="">Selecione...</option><option value="Trabalhista">Trabalhista</option><option value="Cível">Cível</option><option value="Família">Família</option></select></div>
                <div><label for="proximaAudiencia" class="block text-sm font-medium text-gray-700 mb-1">Próxima Audiência</label><input type="date" id="proximaAudiencia" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="tribunal" class="block text-sm font-medium text-gray-700 mb-1">Tribunal</label><input type="text" id="tribunal" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="vara" class="block text-sm font-medium text-gray-700 mb-1">Vara</label><input type="text" id="vara" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
            </div>
            <div id="editExtraFields" class="hidden mt-4">
                <hr class="my-4"><h4 class="text-md font-medium text-gray-700 mb-2">Links de Documentos</h4><div id="linksList" class="space-y-2 mb-2"></div><div class="flex gap-2"><input type="url" id="newLinkUrl" placeholder="URL do documento" class="w-1/2 px-3 py-2 border border-gray-300 rounded-md"><input type="text" id="newLinkDesc" placeholder="Descrição (Ex: Petição Inicial)" class="w-1/2 px-3 py-2 border border-gray-300 rounded-md"><button type="button" id="addLinkBtn" class="bg-blue-500 text-white px-3 rounded-md hover:bg-blue-600"><i class="fa fa-plus"></i></button></div>
            </div>
            <div class="mt-8 flex justify-end gap-3"><button type="button" data-modal-close class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button><button type="submit" class="px-4 py-2 bg-primary text-secondary rounded-md hover:opacity-90 font-semibold">Salvar</button></div>
        </form>
    </div></div>

    <!-- Modal para Adicionar Movimentação -->
    <div id="movimentacaoModal" class="modal"><div class="modal-content animate-fade-in">
        <form id="movimentacaoForm"><h3 class="text-2xl font-bold mb-6 text-primary">Adicionar Movimentação</h3><input type="hidden" id="movimentacaoProcessId"><div><label for="movimentacaoDescricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea id="movimentacaoDescricao" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div><div class="mt-4"><label class="flex items-center"><input type="checkbox" id="definirPrazo" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"> <span class="ml-2 text-sm text-gray-700">Definir prazo fatal</span></label></div><div id="prazoFatalContainer" class="mt-4 hidden"><label for="prazoFatal" class="block text-sm font-medium text-gray-700 mb-1">Data do Prazo</label><input type="date" id="prazoFatal" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="mt-8 flex justify-end gap-3"><button type="button" data-modal-close class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button><button type="submit" class="px-4 py-2 bg-primary text-secondary rounded-md hover:opacity-90 font-semibold">Adicionar</button></div></form>
    </div></div>
    
    <!-- Modal para Editar Movimentação -->
    <div id="movimentacaoEditModal" class="modal"><div class="modal-content animate-fade-in">
        <form id="movimentacaoEditForm"><h3 class="text-2xl font-bold mb-6 text-primary">Editar Movimentação</h3><input type="hidden" id="movimentacaoEditId"><input type="hidden" id="movimentacaoEditProcessId"><div><label for="movimentacaoEditDescricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea id="movimentacaoEditDescricao" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div><div class="mt-4"><label class="flex items-center"><input type="checkbox" id="movimentacaoEditConcluido" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"><span class="ml-2 text-sm text-gray-700">Marcar como concluída</span></label></div><div class="mt-8 flex justify-end gap-3"><button type="button" data-modal-close class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button><button type="submit" class="px-4 py-2 bg-primary text-secondary rounded-md hover:opacity-90 font-semibold">Salvar Alterações</button></div></form>
    </div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTOS DA UI ---
    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app');
    const loginForm = document.getElementById('loginForm');
    
    // Navegação
    const pages = {
        processos: document.getElementById('page-processos'),
        gestao: document.getElementById('page-gestao'),
        config: document.getElementById('page-config')
    };
    const navLinks = {
        processos: document.getElementById('nav-processos'),
        gestao: document.getElementById('nav-gestao'),
        config: document.getElementById('nav-config')
    };

    // Filtros
    const searchInput = document.getElementById('searchInput');
    const tribunalInput = document.getElementById('tribunalInput');
    const varaInput = document.getElementById('varaInput');
    
    // Modais
    const processModal = document.getElementById('processModal');
    const movimentacaoModal = document.getElementById('movimentacaoModal');
    const movimentacaoEditModal = document.getElementById('movimentacaoEditModal');
    
    // Forms
    const processForm = document.getElementById('processForm');
    const movimentacaoForm = document.getElementById('movimentacaoForm');
    const movimentacaoEditForm = document.getElementById('movimentacaoEditForm');

    // Configurações
    const logoUrlInput = document.getElementById('logoUrlInput');
    const saveLogoBtn = document.getElementById('saveLogoBtn');
    const customMenuForm = document.getElementById('customMenuForm');
    const customMenuItemsList = document.getElementById('customMenuItemsList');

    let allProcesses = [];
    let calendarDate = new Date();
    const statusOptions = ["Distribuído", "Pendente de manifestação", "Aguardando Audiência", "Sentença", "Recurso", "Liquidação", "Em fase de execução"];

    // --- LÓGICA DE API ---
    const apiRequest = async (url, options = {}) => {
        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(await response.text());
            if (response.status === 204) return null;
            return response.json();
        } catch (error) {
            console.error('Erro na API:', error);
            alert(`Erro na comunicação com o servidor: ${error.message}`);
            throw error;
        }
    };
    
    // --- LÓGICA DE AUTENTICAÇÃO E INICIALIZAÇÃO ---
    const showLoginScreen = () => { loginScreen.classList.remove('hidden'); appScreen.classList.add('hidden'); sessionStorage.removeItem('loggedIn'); };
    const showAppScreen = () => { loginScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); sessionStorage.setItem('loggedIn', 'true'); navigateTo('processos'); };
    
    const initializeAppSettings = () => {
        // Logo
        const savedLogo = localStorage.getItem('customLogoUrl');
        if (savedLogo) {
            logoUrlInput.value = savedLogo;
            document.getElementById('logoLogin').src = savedLogo;
            document.getElementById('logoApp').src = savedLogo;
        }
        // Menu
        renderCustomMenu();
    };

    loginForm.addEventListener('submit', (e) => { e.preventDefault(); if (document.getElementById('username').value === 'escritorio' && document.getElementById('password').value === '36672456') showAppScreen(); else document.getElementById('loginError').classList.remove('hidden'); });
    document.getElementById('logoutBtn').addEventListener('click', showLoginScreen);
    
    // --- LÓGICA DE NAVEGAÇÃO ---
    const navigateTo = (pageKey) => {
        Object.values(pages).forEach(p => p.classList.add('hidden'));
        Object.values(navLinks).forEach(l => l.classList.remove('active'));
        pages[pageKey].classList.remove('hidden');
        navLinks[pageKey].classList.add('active');

        if (pageKey === 'processos') fetchProcesses();
        if (pageKey === 'gestao') fetchGestaoData();
        if (pageKey === 'config') renderCustomMenuItemsList();
    };
    Object.keys(navLinks).forEach(key => navLinks[key].addEventListener('click', () => navigateTo(key)));

    // --- LÓGICA DE PROCESSOS ---
    const fetchProcesses = async () => {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('processList').innerHTML = '';
        try {
            const params = new URLSearchParams({
                search: searchInput.value,
                tribunal: tribunalInput.value,
                vara: varaInput.value
            }).toString();
            allProcesses = await apiRequest(`/api/processes?${params}`);
            renderProcesses();
        } catch (error) {
            document.getElementById('error-state').classList.remove('hidden');
        }
    };

    const renderProcesses = () => {
        document.getElementById('loading-state').classList.add('hidden');
        const listEl = document.getElementById('processList');
        listEl.innerHTML = '';

        if (allProcesses.length === 0) {
            document.getElementById('no-results').classList.remove('hidden');
            return;
        }
        document.getElementById('no-results').classList.add('hidden');

        allProcesses.forEach(p => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md p-5 border-l-4 border-primary transition hover:shadow-lg';
            card.innerHTML = `
                <div class="flex flex-wrap justify-between items-start gap-4">
                    <div class="flex-grow cursor-pointer" data-action="edit-process" data-id="${p.id}">
                        <div class="flex items-center gap-3 mb-2">
                           <span class="text-xs font-semibold py-1 px-2 rounded-full bg-gray-200 text-gray-800">${p.area_direito || 'N/A'}</span>
                           <span class="text-xs font-semibold py-1 px-2 rounded-full bg-blue-100 text-blue-800">${p.status || 'Não definido'}</span>
                        </div>
                        <h3 class="text-xl font-bold text-primary">${p.numero}</h3>
                        <p class="text-md text-gray-700">${p.cliente}</p>
                        <p class="text-sm text-gray-500 mt-1">${p.tribunal || ''} - ${p.vara || ''}</p>
                    </div>
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <select data-id="${p.id}" class="status-select text-sm border-gray-300 rounded-md">${statusOptions.map(opt => `<option value="${opt}" ${p.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>
                        <button data-id="${p.id}" data-action="add-movimentacao" class="bg-primary text-secondary h-9 w-9 grid place-content-center rounded-full hover:opacity-90" title="Adicionar Movimentação"><i class="fa fa-plus"></i></button>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-500 mb-2">Últimas Movimentações</h4>
                    <div class="space-y-2 text-sm">
                        ${[...(p.movimentacoes || [])].reverse().slice(0, 3).map(m => `
                            <div class="movimentacao-item ${m.concluido ? 'concluida' : ''} p-2 bg-gray-50 rounded-md cursor-pointer hover:bg-gray-100" data-action="edit-movimentacao" data-process-id="${p.id}" data-mov-id="${m.id}">
                                <p class="text-gray-800 pointer-events-none">${m.descricao}</p>
                                <div class="flex justify-between items-center mt-1 pointer-events-none">
                                    <span class="text-xs text-gray-500">${new Date(m.timestamp).toLocaleString('pt-BR')}</span>
                                    ${m.prazo_fatal ? `<span class="text-xs font-semibold text-red-600">Prazo: ${new Date(m.prazo_fatal).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</span>` : ''}
                                </div>
                            </div>
                        `).join('') || '<p class="text-xs text-gray-500">Nenhuma movimentação registada.</p>'}
                    </div>
                </div>
            `;
            listEl.appendChild(card);
        });
    };
    
    [searchInput, tribunalInput, varaInput].forEach(el => el.addEventListener('input', fetchProcesses));

    // --- LÓGICA DOS MODAIS (Abrir/Fechar) ---
    const openModal = (modalElement) => modalElement.style.display = 'flex';
    const closeModal = (modalElement) => modalElement.style.display = 'none';
    document.querySelectorAll('[data-modal-close]').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));
    window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target); });

    // --- LÓGICA GERAL DE AÇÕES (EVENT DELEGATION) ---
    document.getElementById('processList').addEventListener('click', e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const { action, id, processId, movId } = target.dataset;
        const process = allProcesses.find(p => p.id == (id || processId));
        if (!process && action !== 'add-movimentacao') return;
        
        switch (action) {
            case 'edit-process': openProcessModal(process); break;
            case 'add-movimentacao': openMovimentacaoModal(id); break;
            case 'edit-movimentacao': 
                const mov = process.movimentacoes.find(m => m.id == movId);
                if(mov) openMovimentacaoEditModal(processId, mov);
                break;
        }
    });

    document.getElementById('addProcessBtn').addEventListener('click', () => openProcessModal());

    const openProcessModal = (process = null) => {
        processForm.reset();
        document.getElementById('processId').value = process ? process.id : '';
        document.getElementById('processModalTitle').textContent = process ? 'Editar Processo' : 'Novo Processo';
        
        if (process) {
            document.getElementById('numeroProcesso').value = process.numero;
            document.getElementById('nomeCliente').value = process.cliente;
            document.getElementById('areaDireito').value = process.area_direito || '';
            document.getElementById('proximaAudiencia').value = process.proxima_audiencia ? new Date(process.proxima_audiencia).toISOString().split('T')[0] : '';
            document.getElementById('tribunal').value = process.tribunal || '';
            document.getElementById('vara').value = process.vara || '';
            document.getElementById('editExtraFields').classList.remove('hidden');
            renderLinks(process.links);
        } else {
            document.getElementById('editExtraFields').classList.add('hidden');
        }
        openModal(processModal);
    };

    processForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('processId').value;
        const data = {
            numero: document.getElementById('numeroProcesso').value,
            cliente: document.getElementById('nomeCliente').value,
            area_direito: document.getElementById('areaDireito').value,
            proxima_audiencia: document.getElementById('proximaAudiencia').value,
            tribunal: document.getElementById('tribunal').value,
            vara: document.getElementById('vara').value
        };
        
        await apiRequest(id ? `/api/processes/${id}` : '/api/processes', {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        closeModal(processModal);
        fetchProcesses();
    });

    // --- LÓGICA DE MOVIMENTAÇÕES ---
    const openMovimentacaoModal = (processId) => {
        movimentacaoForm.reset();
        document.getElementById('movimentacaoProcessId').value = processId;
        document.getElementById('prazoFatalContainer').classList.add('hidden');
        openModal(movimentacaoModal);
    };
    
    const openMovimentacaoEditModal = (processId, mov) => {
        movimentacaoEditForm.reset();
        document.getElementById('movimentacaoEditProcessId').value = processId;
        document.getElementById('movimentacaoEditId').value = mov.id;
        document.getElementById('movimentacaoEditDescricao').value = mov.descricao;
        document.getElementById('movimentacaoEditConcluido').checked = mov.concluido;
        openModal(movimentacaoEditModal);
    };

    movimentacaoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('movimentacaoProcessId').value;
        const data = {
            descricao: document.getElementById('movimentacaoDescricao').value,
            prazo_fatal: document.getElementById('definirPrazo').checked ? document.getElementById('prazoFatal').value : null
        };
        await apiRequest(`/api/processes/${id}/movimentacoes`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        closeModal(movimentacaoModal);
        fetchProcesses();
    });
    
    movimentacaoEditForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const processId = document.getElementById('movimentacaoEditProcessId').value;
        const movId = document.getElementById('movimentacaoEditId').value;
        const data = {
            descricao: document.getElementById('movimentacaoEditDescricao').value,
            concluido: document.getElementById('movimentacaoEditConcluido').checked
        };
        await apiRequest(`/api/processes/${processId}/movimentacoes/${movId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        closeModal(movimentacaoEditModal);
        fetchProcesses();
    });

    document.getElementById('definirPrazo').addEventListener('change', (e) => document.getElementById('prazoFatalContainer').classList.toggle('hidden', !e.target.checked));
    
    // --- LÓGICA DE STATUS ---
    document.getElementById('processList').addEventListener('change', async (e) => {
        if (e.target.classList.contains('status-select')) {
            const id = e.target.dataset.id;
            const newStatus = e.target.value;
            await apiRequest(`/api/processes/${id}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
            fetchProcesses();
        }
    });

    // --- LÓGICA DA PÁGINA DE GESTÃO E CALENDÁRIO ---
    const fetchGestaoData = async () => { /* ... */ }; // (Omitido por brevidade, lógica similar à V2)
    const renderCalendar = () => { /* ... */ }; // (Omitido por brevidade, lógica similar à V2)

    // --- LÓGICA DE CONFIGURAÇÕES ---
    saveLogoBtn.addEventListener('click', () => {
        const url = logoUrlInput.value;
        localStorage.setItem('customLogoUrl', url);
        document.getElementById('logoLogin').src = url || 'https://placehold.co/300x80/132433/d9d9d9?text=JMD+Advocacia';
        document.getElementById('logoApp').src = url || 'https://placehold.co/200x60/132433/d9d9d9?text=JMD+Advocacia';
    });

    const getCustomMenuItems = () => JSON.parse(localStorage.getItem('customMenuItems') || '[]');
    const saveCustomMenuItems = (items) => localStorage.setItem('customMenuItems', JSON.stringify(items));

    const renderCustomMenu = () => {
        // Remove old custom items
        document.querySelectorAll('.custom-nav-item').forEach(item => item.remove());
        // Add new ones
        const items = getCustomMenuItems();
        items.forEach(item => {
            const link = document.createElement('a');
            link.href = item.url;
            link.textContent = item.text;
            link.target = "_blank"; // Abrir em nova aba
            link.className = 'nav-link custom-nav-item';
            document.getElementById('main-nav').appendChild(link);
        });
    };
    
    const renderCustomMenuItemsList = () => {
        const items = getCustomMenuItems();
        customMenuItemsList.innerHTML = items.map((item, index) => `
            <div class="flex items-center justify-between bg-gray-100 p-2 rounded">
                <span class="text-sm">${item.text} -> ${item.url}</span>
                <button data-index="${index}" class="delete-menu-item-btn text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button>
            </div>
        `).join('') || '<p class="text-xs text-gray-500">Nenhum item de menu personalizado.</p>';
    };

    customMenuForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const items = getCustomMenuItems();
        items.push({ text: document.getElementById('menuText').value, url: document.getElementById('menuUrl').value });
        saveCustomMenuItems(items);
        renderCustomMenu();
        renderCustomMenuItemsList();
        customMenuForm.reset();
    });

    customMenuItemsList.addEventListener('click', e => {
        const btn = e.target.closest('.delete-menu-item-btn');
        if (btn) {
            let items = getCustomMenuItems();
            items.splice(btn.dataset.index, 1);
            saveCustomMenuItems(items);
            renderCustomMenu();
            renderCustomMenuItemsList();
        }
    });

    // --- CÓDIGO RESTANTE (LINKS, CALENDÁRIO, ETC.) ---
    // A lógica para links e calendário é muito similar à V2 e foi omitida aqui por brevidade.
    // O código completo deve incluir essas funções adaptadas ao novo layout de dados se necessário.
    
    // --- INICIALIZAÇÃO ---
    if (sessionStorage.getItem('loggedIn') === 'true') {
        initializeAppSettings();
        showAppScreen();
    } else {
        showLoginScreen();
    }
});
</script>
</body>
</html>
